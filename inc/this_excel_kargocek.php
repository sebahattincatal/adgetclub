<?php
/**
 * Created by PhpStorm.
 * User: Musa ATALAY
 * Date: 21.09.2015
 * Time: 14:46
 */

session_start(); ob_start();
include("include.php");
oturum_koru();

/** Error reporting */
error_reporting(E_ALL);
ini_set('display_errors', TRUE);
ini_set('display_startup_errors', TRUE);
date_default_timezone_set('Europe/Istanbul');
if (PHP_SAPI == 'cli')
    die('This example should only be run from a Web Browser');
/** Include PHPExcel */
require_once dirname(__FILE__) . '/PHPExcel.php';

function exportExcel($filename='ExportExcel',$columns=array(),$data=array(),$replaceDotCol=array()){

    // Create new PHPExcel object
    $objPHPExcel = new PHPExcel();
    // Set document properties
    $objPHPExcel->getProperties()->setCreator("GoInteraktif Panel")
        ->setLastModifiedBy("Go Interaktif Panel")
        ->setTitle("Office 2007 XLSX GoInteraktif Panel Kargo Export")
        ->setSubject("Office 2007 XLSX GoInteraktif Panel Kargo Export")
        ->setDescription("GoInteraktif Panel Kargo Export Office 2007 XLSX, generated by GoInteraktif Panel using PHP.")
        ->setKeywords("GoInteraktif Panel Kargo Export")
        ->setCategory("GoInteraktif Panel Kargo Export");

    // Redirect output to a client’s web browser (Excel5)
    header('Content-Type: application/vnd.ms-excel');
    header('Content-Disposition: attachment;filename="'.$filename.'.xls"');
    header('Cache-Control: max-age=0');
    // If you're serving to IE 9, then the following may be needed
    header('Cache-Control: max-age=1');
    // If you're serving to IE over SSL, then the following may be needed
    header ('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
    header ('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT'); // always modified
    header ('Cache-Control: cache, must-revalidate'); // HTTP/1.1
    header ('Pragma: public'); // HTTP/1.0

    $say=count($columns);

    $alphas = range('A', 'Z');

    foreach($columns AS $index => $value){

        // Add some data
        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($alphas[$index]."1", $value);

        foreach($data AS $i => $d){

            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($alphas[$index].($i+2), $d[$index]);

        }

    }

    // Rename worksheet
    $objPHPExcel->getActiveSheet()->setTitle($filename);

    // Set active sheet index to the first sheet, so Excel opens this as the first sheet
    $objPHPExcel->setActiveSheetIndex(0);

    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
    $objWriter->save('php://output');

    exit;
}

$replaceDotCol=array(3);


/* Sütun Başlıkları */
$columns=array(
    'ALICI ADI-SOYADI ŞİRKET ÜNVANI',
    'ALICI İLÇE',
    'ALICI İL',
    'ALICI ADRESİ',
    'ALICI TEL NO',
    'ŞUBE KODU',
    'MÜŞTERİ BARKODU',
    'ÖDEME ŞART DEĞERİ',
    'ÜRÜN İÇERİĞİ',
    'AĞIRLIK (GR)',
    'SİPARİŞ NO',
	'SATICI',
	'DESİ EN',
	'DESİ BOY',
	'DESİ YÜKSEKLİK',
);

function part($t){
    $xx =explode("/",$t);
    $k=  $xx["2"]."-".$xx["1"]."-".$xx["0"];
    return $k;
}




$d = $db->get_results("SELECT * FROM siparisler where kargocek=1 AND (siparis_durumu = 6 OR siparis_durumu = 7 OR siparis_durumu = 8)  order by siparis_id ASC ");
if($d){
    foreach ($d as  $value) {
        /* Satır Verileri */
		$saticix = mysql_fetch_array(mysql_query("SELECT * FROM admin WHERE admin_id='{$value->personel}'"));
        $data[]=array(
            $value->ad_soyad,
            $value->ilce,
            $value->il,
            $value->adres,
            $value->Telefon_no,
			' ',
            $value->siparis_id,
            $value->fiyat,
            $value->urunun_adi,
			' ',
			$value->siparis_id,
			$saticix['name_surname'],
			' ',
			' ',
			' ',
        );
		mysql_query("UPDATE siparisler SET kargocek=2 WHERE siparis_id='{$value->siparis_id}'");
    }}






$DosyaAdi = "kargo_ciktisi-".rand(1,999);

exportExcel($DosyaAdi,$columns,$data,$replaceDotCol);

exit;